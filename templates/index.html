<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中国A级景区地图</title>
    <style>
        :root {
            --map-width: 100vw;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            gap: 16px; /* 两个控件左右并列，拉开一些间距 */
            align-items: flex-start; /* 保持label+select垂直排布 */
            flex-wrap: nowrap;
            z-index: 1000;
            max-width: calc(100vw - 20px);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .control-group select, .control-group input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--map-width);
            height: 100vh;
            overflow: hidden;
        }
        
        #mapContainer {
            width: 100%;
            height: 100%;
        }
        
        .stats {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: auto;
            font-size: 12px;
            line-height: 1.2;
            display: inline-flex;
            gap: 10px;
        }
        
        .stats h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .stat-item {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
        }
        
        /* 移除右侧侧栏相关样式 */
        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1000;
            font-size: 20px;
            line-height: 1;
            transition: all 0.3s ease;
            display: none;
        }
        
        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
        
        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        .help-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1000;
            font-size: 20px;
            line-height: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-weight: bold;
        }
        
        .help-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .help-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 640px) {
            .help-btn {
                top: 6px;
                right: 6px;
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }

        .welcome-guide {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .welcome-guide.show {
            display: flex;
        }
        
        .welcome-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .welcome-content h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
            text-align: center;
        }
        
        .welcome-steps {
            margin: 20px 0;
            padding-left: 20px;
        }
        
        .welcome-steps li {
            margin: 12px 0;
            color: #666;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .welcome-steps strong {
            color: #667eea;
        }
        
        .welcome-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        .welcome-btn:hover {
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 640px) {
            .welcome-content {
                padding: 20px;
                max-width: 90%;
            }
            
            .welcome-content h2 {
                font-size: 20px;
            }
            
            .welcome-steps li {
                font-size: 14px;
            }
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 640px) {
            :root {
                --map-width: 100vw;
                --sidebar-width: 100vw;
            }
            
            /* 移动端：缩小控制面板 */
            .controls {
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 6px 8px;
                top: 6px;
                left: 6px;
                max-width: calc(100vw - 12px);
                border-radius: 6px;
            }
            
            .control-group {
                gap: 2px;
            }
            
            .control-group label {
                font-size: 11px;
                font-weight: 500;
            }
            
            .control-group select {
                padding: 5px 6px;
                font-size: 11px;
                border-width: 1px;
                border-radius: 4px;
                min-width: 50px;
                max-width: 70px;
                /* 防止iOS全屏显示 */
                -webkit-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 4px center;
                padding-right: 20px;
            }
            
            /* 移动端隐藏统计卡片 */
            .stats {
                display: none !important;
            }
            
            /* 移动端显示全屏按钮 */
            .fullscreen-btn {
                display: block;
                bottom: 8px;
                right: 8px;
                padding: 8px 10px;
                font-size: 18px;
            }
        }
    </style>
    <script type="text/javascript" src="//api.map.baidu.com/api?type=webgl&v=1.0&ak=VXrxLmEeOb7TFUA7SzNj4OZpA3fHmA9K"></script>
</head>
<body>
    <div class="controls">
        <div class="control-group" style="gap:4px;">
            <label for="basemapSelect">底图</label>
            <select id="basemapSelect">
                <option value="vector" selected>矢量</option>
                <option value="satellite">卫星</option>
            </select>
        </div>
        <div class="control-group">
            <label for="levelSelect">等级</label>
            <select id="levelSelect">
                <option value="">全部</option>
                <option value="5A" selected>5A及以上</option>
                <option value="4A">4A及以上</option>
                <option value="3A">3A及以上</option>
                <option value="2A">2A及以上</option>
                <option value="A">A及以上</option>
            </select>
        </div>
    </div>
    
    <div class="map-container">
        <div id="mapContainer"></div>
    </div>
    
    <div class="stats" style="right: 20px; bottom: 20px;">
        <div class="stat-item">数量: <span class="stat-value" id="totalCount">0</span></div>
        <div class="stat-item">范围: <span class="stat-value" id="selectedRegion">当前视口</span></div>
        <div class="stat-item">等级: <span class="stat-value" id="selectedLevel">全部</span></div>
    </div>
    
    <button class="help-btn" id="helpBtn" title="使用帮助">?</button>
    
    <button class="fullscreen-btn" id="fullscreenBtn" title="全屏">⛶</button>
    
    <!-- 首次使用引导 -->
    <div class="welcome-guide" id="welcomeGuide">
        <div class="welcome-content">
            <h2>📍 欢迎使用景区地图</h2>
            <div class="welcome-steps" id="welcomeSteps">
                <!-- 内容将由JavaScript动态生成 -->
            </div>
            <button class="welcome-btn" onclick="closeWelcome()">开始使用</button>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>正在加载景区数据...</p>
    </div>

    <script>
        const IS_MOBILE = {{ is_mobile|lower }};
        
        // 微信浏览器检测与引导跳转
        function isWeChatBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.indexOf('micromessenger') !== -1;
        }
        
        function showWeChatGuide() {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.9);
                z-index: 999999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
            `;
            
            // 创建引导内容
            const guide = document.createElement('div');
            guide.style.cssText = `
                width: 100%;
                padding: 20px;
                text-align: left;
            `;
            
            guide.innerHTML = `
                <div style="
                    font-size: 15px;
                    color: #fff;
                    line-height: 1.8;
                    padding-left: 20px;
                    padding-top: 20px;
                    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGD4DwABBAEAW9JDDAAAAABJRU5ErkJggg==) center top/contain no-repeat;
                ">
                    <p style="margin-bottom: 15px;">
                        <span style="font-size: 20px; font-weight: bold;">⚠️ 请在浏览器中打开</span>
                    </p>
                    <p style="margin-bottom: 10px;">
                        点击右上角 <span style="display: inline-block; padding: 2px 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-weight: bold;">···</span> 按钮
                    </p>
                    <p style="margin-bottom: 30px;">
                        选择 <span style="display: inline-block; padding: 2px 8px; background: rgba(102, 126, 234, 0.8); border-radius: 4px; font-weight: bold;">「在浏览器中打开」</span>
                    </p>
                    <p style="font-size: 13px; color: #999; line-height: 1.6;">
                        💡 微信内置浏览器限制较多<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;建议使用系统浏览器以获得最佳体验
                    </p>
                </div>
                <div style="
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    font-size: 50px;
                    animation: arrowBounce 1.5s ease-in-out infinite;
                ">
                    ↗️
                </div>
            `;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes arrowBounce {
                    0%, 100% { 
                        transform: translate(0, 0); 
                        opacity: 0.6;
                    }
                    50% { 
                        transform: translate(5px, -5px); 
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(guide);
            document.body.appendChild(overlay);
            
            // 禁止页面滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 页面加载时检测微信浏览器
        if (isWeChatBrowser()) {
            // 显示引导页面
            showWeChatGuide();
            // 阻止后续初始化
            throw new Error('WeChat browser detected, please open in system browser.');
        }
        
        // 百度地图GL 实例
        let map;
        let isDragging = false;
        let lastDragTime = 0;
        const markerMap = new Map(); // key -> { label, tip? }
        // 标记增量更新令牌与目标键集合（防止分片插入与快速切换导致的残留）
        let 当前更新令牌 = 0;
        let 当前目标键集合 = new Set();
        
        const 调度 = (fn) => {
            if (window.requestIdleCallback) return requestIdleCallback(fn, { timeout: 200 });
            return requestAnimationFrame(fn);
        };
        
        // 初始化地图
        function 初始化地图() {
            map = new BMapGL.Map('mapContainer');
            const centerPoint = new BMapGL.Point(104.114129, 37.550339); // 中国中心
            map.centerAndZoom(centerPoint, 5);
            map.enableScrollWheelZoom(true);
            // 鼠标指针：地图默认箭头
            if (map.setDefaultCursor) map.setDefaultCursor('default');
            if (map.setDraggingCursor) map.setDraggingCursor('default');

            // 初始化底图与图层
            初始化底图与图层();
        }
        
        // 加载景区数据
        let 当前请求控制器 = null;
        let 加载定时器 = null;

        async function 加载景区数据() {
            const 等级 = document.getElementById('levelSelect').value;
            const bounds = map.getBounds();
            const southWest = bounds.getSouthWest();
            const northEast = bounds.getNorthEast();
            
            显示加载中(true);
            
            try {
                const params = new URLSearchParams({
                    等级: 等级 || '',
                    minLng: southWest.lng,
                    minLat: southWest.lat,
                    maxLng: northEast.lng,
                    maxLat: northEast.lat,
                    limit: '13000'
                });
                if (当前请求控制器) 当前请求控制器.abort();
                当前请求控制器 = new AbortController();
                const url = `/api/景区数据?${params.toString()}`;
                const response = await fetch(url, { signal: 当前请求控制器.signal });
                const result = await response.json();
                
                if (result.error) {
                    alert('数据加载失败: ' + result.error);
                    return;
                }
                
                更新标记(result.data);
                
                const 等级显示 = 等级 ? `${等级}及以上` : '全部';
                更新统计信息(result.total, '当前视口', 等级显示);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('加载数据失败:', error);
                    alert('数据加载失败，请检查网络连接');
                }
            } finally {
                显示加载中(false);
            }
        }

        // 等级切换：先中止旧请求、清除标记、递增令牌，再加载
        function 等级切换刷新(){
            try { if (当前请求控制器) 当前请求控制器.abort(); } catch(e) {}
            清除标记();
            当前目标键集合 = new Set();
            当前更新令牌++;
            加载景区数据();
        }

        // 防抖封装
        function 防抖加载() {
            if (加载定时器) clearTimeout(加载定时器);
            加载定时器 = setTimeout(加载景区数据, 250);
        }
        
        // 生成唯一键
        function 生成键(景区) {
            const 名称 = String(景区.name || '').trim();
            const 等级标准 = 标准化等级文本(景区.level);
            return `${景区.lng},${景区.lat},${名称},${等级标准}`;
        }

        // 移除所有悬浮提示（提高拖动/缩放时性能）
        function 移除所有提示() {
            for (const item of markerMap.values()) {
                if (item.tip) {
                    map.removeOverlay(item.tip);
                    item.tip = null;
                }
                if (item.label && item.label._tip) {
                    try { map.removeOverlay(item.label._tip); } catch(e) {}
                    item.label._tip = null;
                }
            }
        }

        // 批量、增量更新标记（不聚合）
        function 更新标记(列表) {
            // 增量更新令牌，取消旧批次的分片插入
            const myToken = ++当前更新令牌;

            const 新键集合 = new Set();
            for (const item of (列表 || [])) {
                新键集合.add(生成键(item));
            }
            // 记录当前目标键集合，供后续分片插入期间校验
            当前目标键集合 = 新键集合;

            // 移除不在当前集合中的标记（并可靠清理悬浮提示）
            for (const [key, value] of markerMap.entries()) {
                if (!新键集合.has(key)) {
                    if (value.tip) map.removeOverlay(value.tip);
                    if (value.label && value.label._tip) {
                        map.removeOverlay(value.label._tip);
                        value.label._tip = null;
                    }
                    if (value.label) map.removeOverlay(value.label);
                    markerMap.delete(key);
                }
            }

            // 仅添加缺失的，分片插入减少主线程阻塞
            const 待添加 = (列表 || []).filter(item => !markerMap.has(生成键(item)));
            const 分片大小 = 500;
            let 索引 = 0;
            function 分片插入() {
                // 令牌校验，防止旧批次继续插入
                if (myToken !== 当前更新令牌) return;
                const 结束 = Math.min(索引 + 分片大小, 待添加.length);
                for (let i = 索引; i < 结束; i++) {
                    if (myToken !== 当前更新令牌) return;
                    const item = 待添加[i];
                    const key = 生成键(item);
                    // 目标集合二次校验，防止切换等级后旧项混入
                    if (!当前目标键集合.has(key)) continue;
                    const 标注 = 创建标注(item, myToken);
                    markerMap.set(key, 标注);
                }
                索引 = 结束;
                if (索引 < 待添加.length && myToken === 当前更新令牌) {
                    调度(分片插入);
                }
            }
            分片插入();
        }
        
        // 创建单个标注（仅创建圆点标签；提示在悬浮时动态创建与销毁）
        function 创建标注(景区, token) {
            const point = new BMapGL.Point(景区.lng, 景区.lat);
            const html = 生成标注HTML(景区.level, 景区.name);

            const label = new BMapGL.Label(html, {
                position: point,
                // 移动端：容器固定为20x20，圆点在左上角(0,0)，圆点中心在(10,10)
                // 要让圆点中心对齐地理坐标，offset应为(-10, -10)
                // PC端：圆点20px内容 + 3px边框 = 26px总宽高，中心点offset为(-13, -13)
                offset: IS_MOBILE ? new BMapGL.Size(-10, -10) : new BMapGL.Size(-13, -13)
            });
            label.setStyle({
                border: 'none',
                background: 'transparent',
                padding: '0',
                cursor: 'pointer',
                zIndex: 99999
            });
            label.setTitle(景区.name);

            // 悬浮时创建提示；移出时销毁提示（减少 overlay 数量）
            label.addEventListener('mouseover', function() {
                if (isDragging) return;
                const tip = new BMapGL.Label(景区.name, {
                    position: point,
                    offset: new BMapGL.Size(0, -42)
                });
                tip.setStyle({
                    background: 'rgba(255,255,255,0.95)',
                    border: '1px solid #e1e5e9',
                    borderRadius: '6px',
                    padding: '4px 8px',
                    fontSize: '12px',
                    color: '#333',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.18)',
                    transform: 'translateX(-50%)',
                    whiteSpace: 'nowrap',
                    pointerEvents: 'none',
                    zIndex: 100000
                });
                if (tip.setZIndex) tip.setZIndex(100000);
                map.addOverlay(tip);
                const entry = markerMap.get(生成键(景区));
                if (entry) entry.tip = tip;
                // 记录到 label 上，方便强制清理
                try { label._tip = tip; } catch(e) {}
            });
            label.addEventListener('mouseout', function() {
                const entry = markerMap.get(生成键(景区));
                if (entry && entry.tip) {
                    try { map.removeOverlay(entry.tip); } catch(e) {}
                    entry.tip = null;
                }
                if (label && label._tip) {
                    try { map.removeOverlay(label._tip); } catch(e) {}
                    label._tip = null;
                }
            });

            // 避免拖动结束触发点击
            label.addEventListener('click', function() {
                if (isDragging || (Date.now() - lastDragTime) < 250) return;
                
                if (IS_MOBILE) {
                    // 移动端：直接打开小红书App
                    const keyword = encodeURIComponent(景区.name);
                    const appUrl = `xhsdiscover://search/result?keyword=${keyword}`;
                    
                    // 使用iframe打开，避免退出全屏
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = appUrl;
                    document.body.appendChild(iframe);
                    setTimeout(() => {
                        try {
                            document.body.removeChild(iframe);
                        } catch(e) {}
                    }, 1000);
                } else {
                    // PC端：在新窗口打开小红书网页版
                    const url = `https://www.xiaohongshu.com/search_result?keyword=${encodeURIComponent(景区.name)}`;
                    window.open(url, '_blank');
                }
            });

            map.addOverlay(label);
            return { label, tip: null };
        }
        
        // 获取等级对应的颜色
        function 生成标注HTML(等级, 名称){
            const 颜色 = 获取等级颜色(等级);
            const 文本 = 标准化等级文本(等级);
            
            if (IS_MOBILE) {
                // 移动端：使用绝对定位，圆点固定在左上角，名称在圆点下方居中
                return `<div style="position: relative; width: 20px; height: 20px;">
                    <div style="
                        background-color: ${颜色};
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.18);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 8px;
                        position: absolute;
                        top: 0;
                        left: 0;
                    ">${文本}</div>
                    <div style="
                        position: absolute;
                        top: 22px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(255,255,255,0.95);
                        padding: 1px 4px;
                        border-radius: 3px;
                        font-size: 9px;
                        color: #333;
                        white-space: nowrap;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.15);
                        border: 1px solid #e1e5e9;
                        max-width: 80px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    ">${名称}</div>
                </div>`;
            } else {
                // PC端：只显示圆点
                return `<div style="
                    background-color: ${颜色};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.18);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                ">${文本}</div>`;
            }
        }

        function 标准化等级文本(等级){
            const s = String(等级 || '').toUpperCase().replace('Ａ','A').replace('级','').trim();
            if (!s) return '';
            // 将 AAAA 等写法规整为 4A
            if (/^A{2,5}$/.test(s)) return `${s.length}A`;
            // 将 4A级 / 5A景区 等提取数字A
            const m = s.match(/(5A|4A|3A|2A|A)/);
            return m ? m[1] : s;
        }

        function 获取等级颜色(等级) {
            const 颜色映射 = {
                '5A': '#ff4757',  // 红色
                '4A': '#ff6b35',  // 橙色  
                '3A': '#f39c12',  // 黄色
                '2A': '#2ecc71',  // 绿色
                'A': '#3498db'    // 蓝色
            };
            return 颜色映射[等级] || '#95a5a6';
        }
        
        // 清除所有标记
        function 清除标记() {
            for (const { label, tip } of markerMap.values()) {
                if (tip) map.removeOverlay(tip);
                if (label) map.removeOverlay(label);
            }
            markerMap.clear();
        }
        
        // 更新统计信息
        function 更新统计信息(总数, 地区, 等级) {
            document.getElementById('totalCount').textContent = 总数;
            document.getElementById('selectedRegion').textContent = 地区 || '全国';
            document.getElementById('selectedLevel').textContent = 等级 || '全部';
        }
        
        // 显示/隐藏加载状态（禁用加载圈）
        function 显示加载中(显示) {
            return;
        }
        
        // 尺寸变化时校正地图视图，避免标注错位或右下角偏移
        let 尺寸定时器 = null;
        function 处理尺寸变化() {
            if (!map) return;
            // 清除悬浮提示，避免旧像素位置残留
            移除所有提示();
            const center = map.getCenter();
            const zoom = map.getZoom();
            // 通过重新设置中心+缩放强制引擎重算像素坐标
            map.centerAndZoom(center, zoom);
        }
        function 监听窗口尺寸变化() {
            if (尺寸定时器) clearTimeout(尺寸定时器);
            尺寸定时器 = setTimeout(处理尺寸变化, 150);
        }
        

        
        // 图层：底图切换与路况
        let trafficLayer = null;
        function 初始化底图与图层() {
            // 默认矢量底图，无需手动添加
            // 路况图层实例（懒创建）
            trafficLayer = new BMapGL.TrafficLayer({ predictDate: 0 });
        }
        function 切换底图(type) {
            if (type === 'satellite') {
                map.setMapType(BMAP_SATELLITE_MAP);
            } else {
                map.setMapType(BMAP_NORMAL_MAP);
            }
        }
        function 切换路况(enable) {
            if (enable) {
                map.addTileLayer(trafficLayer);
            } else {
                map.removeTileLayer(trafficLayer);
            }
        }

        // 首次使用引导
        function showWelcome() {
            const guide = document.getElementById('welcomeGuide');
            const steps = document.getElementById('welcomeSteps');
            
            if (IS_MOBILE) {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>打开分屏：</strong>将此网页与小红书app通过手机分屏功能分别打开</li>
                        <li><strong>全屏按钮：</strong>点击右下角按钮进入全屏浏览</li>
                        <li><strong>点击景区：</strong>点击你感兴趣的景区会自动转跳小红书</li>
                    </ol>
                `;
            } else {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>打开分屏：</strong>点击Edge右上角三个点，选择"打开分屏"</li>
                        <li><strong>打开小红书：</strong>在右侧搜索并打开小红书网页版，登录账号</li>
                        <li><strong>启用联动：</strong>点击地址栏中间的"打开右侧的左侧链接"按钮</li>
                        <li><strong>点击景点：</strong>点击左侧地图上的景点，右侧小红书会自动跳转搜索</li>
                    </ol>
                `;
            }
            
            guide.classList.add('show');
        }
        
        function closeWelcome() {
            const guide = document.getElementById('welcomeGuide');
            guide.classList.remove('show');
            localStorage.setItem('welcomeShown', 'true');
        }
        
        function toggleWelcome() {
            const guide = document.getElementById('welcomeGuide');
            const steps = document.getElementById('welcomeSteps');
            
            // 更新内容（每次打开都刷新，以防设备类型检测有变化）
            if (IS_MOBILE) {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>打开分屏：</strong>将此网页与小红书app通过手机分屏功能分别打开</li>
                        <li><strong>全屏按钮：</strong>点击右下角按钮进入全屏浏览</li>
                        <li><strong>点击景区：</strong>点击你感兴趣的景区会自动转跳小红书</li>
                    </ol>
                `;
            } else {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>打开分屏：</strong>点击Edge右上角三个点，选择"打开分屏"</li>
                        <li><strong>打开小红书：</strong>在右侧搜索并打开小红书网页版，登录账号</li>
                        <li><strong>启用联动：</strong>点击地址栏中间的"打开右侧的左侧链接"按钮</li>
                        <li><strong>点击景点：</strong>点击左侧地图上的景点，右侧小红书会自动跳转搜索</li>
                    </ol>
                `;
            }
            
            if (guide.classList.contains('show')) {
                guide.classList.remove('show');
            } else {
                guide.classList.add('show');
            }
        }
        
        // 检查是否首次访问
        function checkFirstVisit() {
            const hasShown = localStorage.getItem('welcomeShown');
            if (!hasShown) {
                setTimeout(showWelcome, 500);
            }
        }
        

        // 页面加载完成后初始化
        window.onload = function() {
            // 移动端缩短下拉框文字
            if (IS_MOBILE) {
                const levelSelect = document.getElementById('levelSelect');
                const options = levelSelect.options;
                for (let i = 1; i < options.length; i++) {
                    const value = options[i].value;
                    options[i].text = value + '+';
                }
            }
            
            初始化地图();
            加载景区数据();
            // 交互事件：视口或等级变化时重载
            map.addEventListener('zoomstart', function(){
                isDragging = true;
                移除所有提示();
            });
            map.addEventListener('zoomend', function(){
                isDragging = false;
                防抖加载();
            });
            map.addEventListener('dragstart', function() {
                isDragging = true;
                移除所有提示();
            });
            map.addEventListener('dragend', function() {
                isDragging = false;
                lastDragTime = Date.now();
                防抖加载();
            });
            document.getElementById('levelSelect').addEventListener('change', 等级切换刷新);

            // 监听窗口尺寸变化
            window.addEventListener('resize', 监听窗口尺寸变化);

            // 底图控制
            const basemapSelect = document.getElementById('basemapSelect');
            basemapSelect.addEventListener('change', () => 切换底图(basemapSelect.value));
            
            // 全屏按钮功能
            if (IS_MOBILE) {
                const fullscreenBtn = document.getElementById('fullscreenBtn');
                fullscreenBtn.addEventListener('click', function() {
                    const elem = document.documentElement;
                    
                    if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                        !document.mozFullScreenElement && !document.msFullscreenElement) {
                        // 进入全屏
                        if (elem.requestFullscreen) {
                            elem.requestFullscreen();
                        } else if (elem.webkitRequestFullscreen) {
                            elem.webkitRequestFullscreen();
                        } else if (elem.mozRequestFullScreen) {
                            elem.mozRequestFullScreen();
                        } else if (elem.msRequestFullscreen) {
                            elem.msRequestFullscreen();
                        }
                        fullscreenBtn.textContent = '⛶';
                    } else {
                        // 退出全屏
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.mozCancelFullScreen) {
                            document.mozCancelFullScreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                        fullscreenBtn.textContent = '⛶';
                    }
                });
                
                // 监听全屏状态变化
                document.addEventListener('fullscreenchange', updateFullscreenButton);
                document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
                document.addEventListener('mozfullscreenchange', updateFullscreenButton);
                document.addEventListener('MSFullscreenChange', updateFullscreenButton);
                
                function updateFullscreenButton() {
                    const fullscreenBtn = document.getElementById('fullscreenBtn');
                    if (document.fullscreenElement || document.webkitFullscreenElement || 
                        document.mozFullScreenElement || document.msFullscreenElement) {
                        fullscreenBtn.textContent = '⛶';
                    } else {
                        fullscreenBtn.textContent = '⛶';
                    }
                }
            }
            
            // 检查首次访问
            checkFirstVisit();
            
            // 帮助按钮点击事件
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', toggleWelcome);
            }
        };
    </script>
</body>
</html>
