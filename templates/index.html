<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½Açº§æ™¯åŒºåœ°å›¾</title>
    <style>
        :root {
            --map-width: 100vw;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            gap: 16px; /* ä¸¤ä¸ªæ§ä»¶å·¦å³å¹¶åˆ—ï¼Œæ‹‰å¼€ä¸€äº›é—´è· */
            align-items: flex-start; /* ä¿æŒlabel+selectå‚ç›´æ’å¸ƒ */
            flex-wrap: nowrap;
            z-index: 1000;
            max-width: calc(100vw - 20px);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .control-group select, .control-group input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--map-width);
            height: 100vh;
            overflow: hidden;
        }
        
        #mapContainer {
            width: 100%;
            height: 100%;
        }
        
        .stats {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: auto;
            font-size: 12px;
            line-height: 1.2;
            display: inline-flex;
            gap: 10px;
        }
        
        .stats h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .stat-item {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #667eea;
        }
        
        /* ç§»é™¤å³ä¾§ä¾§æ ç›¸å…³æ ·å¼ */
        .fullscreen-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1000;
            font-size: 20px;
            line-height: 1;
            transition: all 0.3s ease;
            display: none;
        }
        
        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
        
        .fullscreen-btn:active {
            transform: scale(0.95);
        }

        .help-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 1000;
            font-size: 20px;
            line-height: 1;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-weight: bold;
        }
        
        .help-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .help-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 640px) {
            .help-btn {
                top: 6px;
                right: 6px;
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }

        .welcome-guide {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .welcome-guide.show {
            display: flex;
        }
        
        .welcome-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .welcome-content h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 24px;
            text-align: center;
        }
        
        .welcome-steps {
            margin: 20px 0;
            padding-left: 20px;
        }
        
        .welcome-steps li {
            margin: 12px 0;
            color: #666;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .welcome-steps strong {
            color: #667eea;
        }
        
        .welcome-btn {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        .welcome-btn:hover {
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @media (max-width: 640px) {
            .welcome-content {
                padding: 20px;
                max-width: 90%;
            }
            
            .welcome-content h2 {
                font-size: 20px;
            }
            
            .welcome-steps li {
                font-size: 14px;
            }
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 640px) {
            :root {
                --map-width: 100vw;
                --sidebar-width: 100vw;
            }
            
            /* ç§»åŠ¨ç«¯ï¼šç¼©å°æ§åˆ¶é¢æ¿ */
            .controls {
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 6px 8px;
                top: 6px;
                left: 6px;
                max-width: calc(100vw - 12px);
                border-radius: 6px;
            }
            
            .control-group {
                gap: 2px;
            }
            
            .control-group label {
                font-size: 11px;
                font-weight: 500;
            }
            
            .control-group select {
                padding: 5px 6px;
                font-size: 11px;
                border-width: 1px;
                border-radius: 4px;
                min-width: 50px;
                max-width: 70px;
                /* é˜²æ­¢iOSå…¨å±æ˜¾ç¤º */
                -webkit-appearance: none;
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 4px center;
                padding-right: 20px;
            }
            
            /* ç§»åŠ¨ç«¯éšè—ç»Ÿè®¡å¡ç‰‡ */
            .stats {
                display: none !important;
            }
            
            /* ç§»åŠ¨ç«¯æ˜¾ç¤ºå…¨å±æŒ‰é’® */
            .fullscreen-btn {
                display: block;
                bottom: 8px;
                right: 8px;
                padding: 8px 10px;
                font-size: 18px;
            }
        }
    </style>
    <script type="text/javascript" src="//api.map.baidu.com/api?type=webgl&v=1.0&ak=VXrxLmEeOb7TFUA7SzNj4OZpA3fHmA9K"></script>
</head>
<body>
    <div class="controls">
        <div class="control-group" style="gap:4px;">
            <label for="basemapSelect">åº•å›¾</label>
            <select id="basemapSelect">
                <option value="vector" selected>çŸ¢é‡</option>
                <option value="satellite">å«æ˜Ÿ</option>
            </select>
        </div>
        <div class="control-group">
            <label for="levelSelect">ç­‰çº§</label>
            <select id="levelSelect">
                <option value="">å…¨éƒ¨</option>
                <option value="5A" selected>5AåŠä»¥ä¸Š</option>
                <option value="4A">4AåŠä»¥ä¸Š</option>
                <option value="3A">3AåŠä»¥ä¸Š</option>
                <option value="2A">2AåŠä»¥ä¸Š</option>
                <option value="A">AåŠä»¥ä¸Š</option>
            </select>
        </div>
    </div>
    
    <div class="map-container">
        <div id="mapContainer"></div>
    </div>
    
    <div class="stats" style="right: 20px; bottom: 20px;">
        <div class="stat-item">æ•°é‡: <span class="stat-value" id="totalCount">0</span></div>
        <div class="stat-item">èŒƒå›´: <span class="stat-value" id="selectedRegion">å½“å‰è§†å£</span></div>
        <div class="stat-item">ç­‰çº§: <span class="stat-value" id="selectedLevel">å…¨éƒ¨</span></div>
    </div>
    
    <button class="help-btn" id="helpBtn" title="ä½¿ç”¨å¸®åŠ©">?</button>
    
    <button class="fullscreen-btn" id="fullscreenBtn" title="å…¨å±">â›¶</button>
    
    <!-- é¦–æ¬¡ä½¿ç”¨å¼•å¯¼ -->
    <div class="welcome-guide" id="welcomeGuide">
        <div class="welcome-content">
            <h2>ğŸ“ æ¬¢è¿ä½¿ç”¨æ™¯åŒºåœ°å›¾</h2>
            <div class="welcome-steps" id="welcomeSteps">
                <!-- å†…å®¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="welcome-btn" onclick="closeWelcome()">å¼€å§‹ä½¿ç”¨</button>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åŠ è½½æ™¯åŒºæ•°æ®...</p>
    </div>

    <script>
        const IS_MOBILE = {{ is_mobile|lower }};
        
        // å¾®ä¿¡æµè§ˆå™¨æ£€æµ‹ä¸å¼•å¯¼è·³è½¬
        function isWeChatBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.indexOf('micromessenger') !== -1;
        }
        
        function showWeChatGuide() {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.9);
                z-index: 999999;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
            `;
            
            // åˆ›å»ºå¼•å¯¼å†…å®¹
            const guide = document.createElement('div');
            guide.style.cssText = `
                width: 100%;
                padding: 20px;
                text-align: left;
            `;
            
            guide.innerHTML = `
                <div style="
                    font-size: 15px;
                    color: #fff;
                    line-height: 1.8;
                    padding-left: 20px;
                    padding-top: 20px;
                    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGD4DwABBAEAW9JDDAAAAABJRU5ErkJggg==) center top/contain no-repeat;
                ">
                    <p style="margin-bottom: 15px;">
                        <span style="font-size: 20px; font-weight: bold;">âš ï¸ è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</span>
                    </p>
                    <p style="margin-bottom: 10px;">
                        ç‚¹å‡»å³ä¸Šè§’ <span style="display: inline-block; padding: 2px 8px; background: rgba(255,255,255,0.2); border-radius: 4px; font-weight: bold;">Â·Â·Â·</span> æŒ‰é’®
                    </p>
                    <p style="margin-bottom: 30px;">
                        é€‰æ‹© <span style="display: inline-block; padding: 2px 8px; background: rgba(102, 126, 234, 0.8); border-radius: 4px; font-weight: bold;">ã€Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ã€</span>
                    </p>
                    <p style="font-size: 13px; color: #999; line-height: 1.6;">
                        ğŸ’¡ å¾®ä¿¡å†…ç½®æµè§ˆå™¨é™åˆ¶è¾ƒå¤š<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;å»ºè®®ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨ä»¥è·å¾—æœ€ä½³ä½“éªŒ
                    </p>
                </div>
                <div style="
                    position: absolute;
                    top: 10px;
                    right: 15px;
                    font-size: 50px;
                    animation: arrowBounce 1.5s ease-in-out infinite;
                ">
                    â†—ï¸
                </div>
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes arrowBounce {
                    0%, 100% { 
                        transform: translate(0, 0); 
                        opacity: 0.6;
                    }
                    50% { 
                        transform: translate(5px, -5px); 
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(guide);
            document.body.appendChild(overlay);
            
            // ç¦æ­¢é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨
        if (isWeChatBrowser()) {
            // æ˜¾ç¤ºå¼•å¯¼é¡µé¢
            showWeChatGuide();
            // é˜»æ­¢åç»­åˆå§‹åŒ–
            throw new Error('WeChat browser detected, please open in system browser.');
        }
        
        // ç™¾åº¦åœ°å›¾GL å®ä¾‹
        let map;
        let isDragging = false;
        let lastDragTime = 0;
        const markerMap = new Map(); // key -> { label, tip? }
        // æ ‡è®°å¢é‡æ›´æ–°ä»¤ç‰Œä¸ç›®æ ‡é”®é›†åˆï¼ˆé˜²æ­¢åˆ†ç‰‡æ’å…¥ä¸å¿«é€Ÿåˆ‡æ¢å¯¼è‡´çš„æ®‹ç•™ï¼‰
        let å½“å‰æ›´æ–°ä»¤ç‰Œ = 0;
        let å½“å‰ç›®æ ‡é”®é›†åˆ = new Set();
        
        const è°ƒåº¦ = (fn) => {
            if (window.requestIdleCallback) return requestIdleCallback(fn, { timeout: 200 });
            return requestAnimationFrame(fn);
        };
        
        // åˆå§‹åŒ–åœ°å›¾
        function åˆå§‹åŒ–åœ°å›¾() {
            map = new BMapGL.Map('mapContainer');
            const centerPoint = new BMapGL.Point(104.114129, 37.550339); // ä¸­å›½ä¸­å¿ƒ
            map.centerAndZoom(centerPoint, 5);
            map.enableScrollWheelZoom(true);
            // é¼ æ ‡æŒ‡é’ˆï¼šåœ°å›¾é»˜è®¤ç®­å¤´
            if (map.setDefaultCursor) map.setDefaultCursor('default');
            if (map.setDraggingCursor) map.setDraggingCursor('default');

            // åˆå§‹åŒ–åº•å›¾ä¸å›¾å±‚
            åˆå§‹åŒ–åº•å›¾ä¸å›¾å±‚();
        }
        
        // åŠ è½½æ™¯åŒºæ•°æ®
        let å½“å‰è¯·æ±‚æ§åˆ¶å™¨ = null;
        let åŠ è½½å®šæ—¶å™¨ = null;

        async function åŠ è½½æ™¯åŒºæ•°æ®() {
            const ç­‰çº§ = document.getElementById('levelSelect').value;
            const bounds = map.getBounds();
            const southWest = bounds.getSouthWest();
            const northEast = bounds.getNorthEast();
            
            æ˜¾ç¤ºåŠ è½½ä¸­(true);
            
            try {
                const params = new URLSearchParams({
                    ç­‰çº§: ç­‰çº§ || '',
                    minLng: southWest.lng,
                    minLat: southWest.lat,
                    maxLng: northEast.lng,
                    maxLat: northEast.lat,
                    limit: '13000'
                });
                if (å½“å‰è¯·æ±‚æ§åˆ¶å™¨) å½“å‰è¯·æ±‚æ§åˆ¶å™¨.abort();
                å½“å‰è¯·æ±‚æ§åˆ¶å™¨ = new AbortController();
                const url = `/api/æ™¯åŒºæ•°æ®?${params.toString()}`;
                const response = await fetch(url, { signal: å½“å‰è¯·æ±‚æ§åˆ¶å™¨.signal });
                const result = await response.json();
                
                if (result.error) {
                    alert('æ•°æ®åŠ è½½å¤±è´¥: ' + result.error);
                    return;
                }
                
                æ›´æ–°æ ‡è®°(result.data);
                
                const ç­‰çº§æ˜¾ç¤º = ç­‰çº§ ? `${ç­‰çº§}åŠä»¥ä¸Š` : 'å…¨éƒ¨';
                æ›´æ–°ç»Ÿè®¡ä¿¡æ¯(result.total, 'å½“å‰è§†å£', ç­‰çº§æ˜¾ç¤º);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            } finally {
                æ˜¾ç¤ºåŠ è½½ä¸­(false);
            }
        }

        // ç­‰çº§åˆ‡æ¢ï¼šå…ˆä¸­æ­¢æ—§è¯·æ±‚ã€æ¸…é™¤æ ‡è®°ã€é€’å¢ä»¤ç‰Œï¼Œå†åŠ è½½
        function ç­‰çº§åˆ‡æ¢åˆ·æ–°(){
            try { if (å½“å‰è¯·æ±‚æ§åˆ¶å™¨) å½“å‰è¯·æ±‚æ§åˆ¶å™¨.abort(); } catch(e) {}
            æ¸…é™¤æ ‡è®°();
            å½“å‰ç›®æ ‡é”®é›†åˆ = new Set();
            å½“å‰æ›´æ–°ä»¤ç‰Œ++;
            åŠ è½½æ™¯åŒºæ•°æ®();
        }

        // é˜²æŠ–å°è£…
        function é˜²æŠ–åŠ è½½() {
            if (åŠ è½½å®šæ—¶å™¨) clearTimeout(åŠ è½½å®šæ—¶å™¨);
            åŠ è½½å®šæ—¶å™¨ = setTimeout(åŠ è½½æ™¯åŒºæ•°æ®, 250);
        }
        
        // ç”Ÿæˆå”¯ä¸€é”®
        function ç”Ÿæˆé”®(æ™¯åŒº) {
            const åç§° = String(æ™¯åŒº.name || '').trim();
            const ç­‰çº§æ ‡å‡† = æ ‡å‡†åŒ–ç­‰çº§æ–‡æœ¬(æ™¯åŒº.level);
            return `${æ™¯åŒº.lng},${æ™¯åŒº.lat},${åç§°},${ç­‰çº§æ ‡å‡†}`;
        }

        // ç§»é™¤æ‰€æœ‰æ‚¬æµ®æç¤ºï¼ˆæé«˜æ‹–åŠ¨/ç¼©æ”¾æ—¶æ€§èƒ½ï¼‰
        function ç§»é™¤æ‰€æœ‰æç¤º() {
            for (const item of markerMap.values()) {
                if (item.tip) {
                    map.removeOverlay(item.tip);
                    item.tip = null;
                }
                if (item.label && item.label._tip) {
                    try { map.removeOverlay(item.label._tip); } catch(e) {}
                    item.label._tip = null;
                }
            }
        }

        // æ‰¹é‡ã€å¢é‡æ›´æ–°æ ‡è®°ï¼ˆä¸èšåˆï¼‰
        function æ›´æ–°æ ‡è®°(åˆ—è¡¨) {
            // å¢é‡æ›´æ–°ä»¤ç‰Œï¼Œå–æ¶ˆæ—§æ‰¹æ¬¡çš„åˆ†ç‰‡æ’å…¥
            const myToken = ++å½“å‰æ›´æ–°ä»¤ç‰Œ;

            const æ–°é”®é›†åˆ = new Set();
            for (const item of (åˆ—è¡¨ || [])) {
                æ–°é”®é›†åˆ.add(ç”Ÿæˆé”®(item));
            }
            // è®°å½•å½“å‰ç›®æ ‡é”®é›†åˆï¼Œä¾›åç»­åˆ†ç‰‡æ’å…¥æœŸé—´æ ¡éªŒ
            å½“å‰ç›®æ ‡é”®é›†åˆ = æ–°é”®é›†åˆ;

            // ç§»é™¤ä¸åœ¨å½“å‰é›†åˆä¸­çš„æ ‡è®°ï¼ˆå¹¶å¯é æ¸…ç†æ‚¬æµ®æç¤ºï¼‰
            for (const [key, value] of markerMap.entries()) {
                if (!æ–°é”®é›†åˆ.has(key)) {
                    if (value.tip) map.removeOverlay(value.tip);
                    if (value.label && value.label._tip) {
                        map.removeOverlay(value.label._tip);
                        value.label._tip = null;
                    }
                    if (value.label) map.removeOverlay(value.label);
                    markerMap.delete(key);
                }
            }

            // ä»…æ·»åŠ ç¼ºå¤±çš„ï¼Œåˆ†ç‰‡æ’å…¥å‡å°‘ä¸»çº¿ç¨‹é˜»å¡
            const å¾…æ·»åŠ  = (åˆ—è¡¨ || []).filter(item => !markerMap.has(ç”Ÿæˆé”®(item)));
            const åˆ†ç‰‡å¤§å° = 500;
            let ç´¢å¼• = 0;
            function åˆ†ç‰‡æ’å…¥() {
                // ä»¤ç‰Œæ ¡éªŒï¼Œé˜²æ­¢æ—§æ‰¹æ¬¡ç»§ç»­æ’å…¥
                if (myToken !== å½“å‰æ›´æ–°ä»¤ç‰Œ) return;
                const ç»“æŸ = Math.min(ç´¢å¼• + åˆ†ç‰‡å¤§å°, å¾…æ·»åŠ .length);
                for (let i = ç´¢å¼•; i < ç»“æŸ; i++) {
                    if (myToken !== å½“å‰æ›´æ–°ä»¤ç‰Œ) return;
                    const item = å¾…æ·»åŠ [i];
                    const key = ç”Ÿæˆé”®(item);
                    // ç›®æ ‡é›†åˆäºŒæ¬¡æ ¡éªŒï¼Œé˜²æ­¢åˆ‡æ¢ç­‰çº§åæ—§é¡¹æ··å…¥
                    if (!å½“å‰ç›®æ ‡é”®é›†åˆ.has(key)) continue;
                    const æ ‡æ³¨ = åˆ›å»ºæ ‡æ³¨(item, myToken);
                    markerMap.set(key, æ ‡æ³¨);
                }
                ç´¢å¼• = ç»“æŸ;
                if (ç´¢å¼• < å¾…æ·»åŠ .length && myToken === å½“å‰æ›´æ–°ä»¤ç‰Œ) {
                    è°ƒåº¦(åˆ†ç‰‡æ’å…¥);
                }
            }
            åˆ†ç‰‡æ’å…¥();
        }
        
        // åˆ›å»ºå•ä¸ªæ ‡æ³¨ï¼ˆä»…åˆ›å»ºåœ†ç‚¹æ ‡ç­¾ï¼›æç¤ºåœ¨æ‚¬æµ®æ—¶åŠ¨æ€åˆ›å»ºä¸é”€æ¯ï¼‰
        function åˆ›å»ºæ ‡æ³¨(æ™¯åŒº, token) {
            const point = new BMapGL.Point(æ™¯åŒº.lng, æ™¯åŒº.lat);
            const html = ç”Ÿæˆæ ‡æ³¨HTML(æ™¯åŒº.level, æ™¯åŒº.name);

            const label = new BMapGL.Label(html, {
                position: point,
                // ç§»åŠ¨ç«¯ï¼šå®¹å™¨å›ºå®šä¸º20x20ï¼Œåœ†ç‚¹åœ¨å·¦ä¸Šè§’(0,0)ï¼Œåœ†ç‚¹ä¸­å¿ƒåœ¨(10,10)
                // è¦è®©åœ†ç‚¹ä¸­å¿ƒå¯¹é½åœ°ç†åæ ‡ï¼Œoffsetåº”ä¸º(-10, -10)
                // PCç«¯ï¼šåœ†ç‚¹20pxå†…å®¹ + 3pxè¾¹æ¡† = 26pxæ€»å®½é«˜ï¼Œä¸­å¿ƒç‚¹offsetä¸º(-13, -13)
                offset: IS_MOBILE ? new BMapGL.Size(-10, -10) : new BMapGL.Size(-13, -13)
            });
            label.setStyle({
                border: 'none',
                background: 'transparent',
                padding: '0',
                cursor: 'pointer',
                zIndex: 99999
            });
            label.setTitle(æ™¯åŒº.name);

            // æ‚¬æµ®æ—¶åˆ›å»ºæç¤ºï¼›ç§»å‡ºæ—¶é”€æ¯æç¤ºï¼ˆå‡å°‘ overlay æ•°é‡ï¼‰
            label.addEventListener('mouseover', function() {
                if (isDragging) return;
                const tip = new BMapGL.Label(æ™¯åŒº.name, {
                    position: point,
                    offset: new BMapGL.Size(0, -42)
                });
                tip.setStyle({
                    background: 'rgba(255,255,255,0.95)',
                    border: '1px solid #e1e5e9',
                    borderRadius: '6px',
                    padding: '4px 8px',
                    fontSize: '12px',
                    color: '#333',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.18)',
                    transform: 'translateX(-50%)',
                    whiteSpace: 'nowrap',
                    pointerEvents: 'none',
                    zIndex: 100000
                });
                if (tip.setZIndex) tip.setZIndex(100000);
                map.addOverlay(tip);
                const entry = markerMap.get(ç”Ÿæˆé”®(æ™¯åŒº));
                if (entry) entry.tip = tip;
                // è®°å½•åˆ° label ä¸Šï¼Œæ–¹ä¾¿å¼ºåˆ¶æ¸…ç†
                try { label._tip = tip; } catch(e) {}
            });
            label.addEventListener('mouseout', function() {
                const entry = markerMap.get(ç”Ÿæˆé”®(æ™¯åŒº));
                if (entry && entry.tip) {
                    try { map.removeOverlay(entry.tip); } catch(e) {}
                    entry.tip = null;
                }
                if (label && label._tip) {
                    try { map.removeOverlay(label._tip); } catch(e) {}
                    label._tip = null;
                }
            });

            // é¿å…æ‹–åŠ¨ç»“æŸè§¦å‘ç‚¹å‡»
            label.addEventListener('click', function() {
                if (isDragging || (Date.now() - lastDragTime) < 250) return;
                
                if (IS_MOBILE) {
                    // ç§»åŠ¨ç«¯ï¼šç›´æ¥æ‰“å¼€å°çº¢ä¹¦App
                    const keyword = encodeURIComponent(æ™¯åŒº.name);
                    const appUrl = `xhsdiscover://search/result?keyword=${keyword}`;
                    
                    // ä½¿ç”¨iframeæ‰“å¼€ï¼Œé¿å…é€€å‡ºå…¨å±
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = appUrl;
                    document.body.appendChild(iframe);
                    setTimeout(() => {
                        try {
                            document.body.removeChild(iframe);
                        } catch(e) {}
                    }, 1000);
                } else {
                    // PCç«¯ï¼šåœ¨æ–°çª—å£æ‰“å¼€å°çº¢ä¹¦ç½‘é¡µç‰ˆ
                    const url = `https://www.xiaohongshu.com/search_result?keyword=${encodeURIComponent(æ™¯åŒº.name)}`;
                    window.open(url, '_blank');
                }
            });

            map.addOverlay(label);
            return { label, tip: null };
        }
        
        // è·å–ç­‰çº§å¯¹åº”çš„é¢œè‰²
        function ç”Ÿæˆæ ‡æ³¨HTML(ç­‰çº§, åç§°){
            const é¢œè‰² = è·å–ç­‰çº§é¢œè‰²(ç­‰çº§);
            const æ–‡æœ¬ = æ ‡å‡†åŒ–ç­‰çº§æ–‡æœ¬(ç­‰çº§);
            
            if (IS_MOBILE) {
                // ç§»åŠ¨ç«¯ï¼šä½¿ç”¨ç»å¯¹å®šä½ï¼Œåœ†ç‚¹å›ºå®šåœ¨å·¦ä¸Šè§’ï¼Œåç§°åœ¨åœ†ç‚¹ä¸‹æ–¹å±…ä¸­
                return `<div style="position: relative; width: 20px; height: 20px;">
                    <div style="
                        background-color: ${é¢œè‰²};
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.18);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 8px;
                        position: absolute;
                        top: 0;
                        left: 0;
                    ">${æ–‡æœ¬}</div>
                    <div style="
                        position: absolute;
                        top: 22px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(255,255,255,0.95);
                        padding: 1px 4px;
                        border-radius: 3px;
                        font-size: 9px;
                        color: #333;
                        white-space: nowrap;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.15);
                        border: 1px solid #e1e5e9;
                        max-width: 80px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    ">${åç§°}</div>
                </div>`;
            } else {
                // PCç«¯ï¼šåªæ˜¾ç¤ºåœ†ç‚¹
                return `<div style="
                    background-color: ${é¢œè‰²};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.18);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 10px;
                ">${æ–‡æœ¬}</div>`;
            }
        }

        function æ ‡å‡†åŒ–ç­‰çº§æ–‡æœ¬(ç­‰çº§){
            const s = String(ç­‰çº§ || '').toUpperCase().replace('ï¼¡','A').replace('çº§','').trim();
            if (!s) return '';
            // å°† AAAA ç­‰å†™æ³•è§„æ•´ä¸º 4A
            if (/^A{2,5}$/.test(s)) return `${s.length}A`;
            // å°† 4Açº§ / 5Aæ™¯åŒº ç­‰æå–æ•°å­—A
            const m = s.match(/(5A|4A|3A|2A|A)/);
            return m ? m[1] : s;
        }

        function è·å–ç­‰çº§é¢œè‰²(ç­‰çº§) {
            const é¢œè‰²æ˜ å°„ = {
                '5A': '#ff4757',  // çº¢è‰²
                '4A': '#ff6b35',  // æ©™è‰²  
                '3A': '#f39c12',  // é»„è‰²
                '2A': '#2ecc71',  // ç»¿è‰²
                'A': '#3498db'    // è“è‰²
            };
            return é¢œè‰²æ˜ å°„[ç­‰çº§] || '#95a5a6';
        }
        
        // æ¸…é™¤æ‰€æœ‰æ ‡è®°
        function æ¸…é™¤æ ‡è®°() {
            for (const { label, tip } of markerMap.values()) {
                if (tip) map.removeOverlay(tip);
                if (label) map.removeOverlay(label);
            }
            markerMap.clear();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function æ›´æ–°ç»Ÿè®¡ä¿¡æ¯(æ€»æ•°, åœ°åŒº, ç­‰çº§) {
            document.getElementById('totalCount').textContent = æ€»æ•°;
            document.getElementById('selectedRegion').textContent = åœ°åŒº || 'å…¨å›½';
            document.getElementById('selectedLevel').textContent = ç­‰çº§ || 'å…¨éƒ¨';
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€ï¼ˆç¦ç”¨åŠ è½½åœˆï¼‰
        function æ˜¾ç¤ºåŠ è½½ä¸­(æ˜¾ç¤º) {
            return;
        }
        
        // å°ºå¯¸å˜åŒ–æ—¶æ ¡æ­£åœ°å›¾è§†å›¾ï¼Œé¿å…æ ‡æ³¨é”™ä½æˆ–å³ä¸‹è§’åç§»
        let å°ºå¯¸å®šæ—¶å™¨ = null;
        function å¤„ç†å°ºå¯¸å˜åŒ–() {
            if (!map) return;
            // æ¸…é™¤æ‚¬æµ®æç¤ºï¼Œé¿å…æ—§åƒç´ ä½ç½®æ®‹ç•™
            ç§»é™¤æ‰€æœ‰æç¤º();
            const center = map.getCenter();
            const zoom = map.getZoom();
            // é€šè¿‡é‡æ–°è®¾ç½®ä¸­å¿ƒ+ç¼©æ”¾å¼ºåˆ¶å¼•æ“é‡ç®—åƒç´ åæ ‡
            map.centerAndZoom(center, zoom);
        }
        function ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–() {
            if (å°ºå¯¸å®šæ—¶å™¨) clearTimeout(å°ºå¯¸å®šæ—¶å™¨);
            å°ºå¯¸å®šæ—¶å™¨ = setTimeout(å¤„ç†å°ºå¯¸å˜åŒ–, 150);
        }
        

        
        // å›¾å±‚ï¼šåº•å›¾åˆ‡æ¢ä¸è·¯å†µ
        let trafficLayer = null;
        function åˆå§‹åŒ–åº•å›¾ä¸å›¾å±‚() {
            // é»˜è®¤çŸ¢é‡åº•å›¾ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ 
            // è·¯å†µå›¾å±‚å®ä¾‹ï¼ˆæ‡’åˆ›å»ºï¼‰
            trafficLayer = new BMapGL.TrafficLayer({ predictDate: 0 });
        }
        function åˆ‡æ¢åº•å›¾(type) {
            if (type === 'satellite') {
                map.setMapType(BMAP_SATELLITE_MAP);
            } else {
                map.setMapType(BMAP_NORMAL_MAP);
            }
        }
        function åˆ‡æ¢è·¯å†µ(enable) {
            if (enable) {
                map.addTileLayer(trafficLayer);
            } else {
                map.removeTileLayer(trafficLayer);
            }
        }

        // é¦–æ¬¡ä½¿ç”¨å¼•å¯¼
        function showWelcome() {
            const guide = document.getElementById('welcomeGuide');
            const steps = document.getElementById('welcomeSteps');
            
            if (IS_MOBILE) {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>æ‰“å¼€åˆ†å±ï¼š</strong>å°†æ­¤ç½‘é¡µä¸å°çº¢ä¹¦appé€šè¿‡æ‰‹æœºåˆ†å±åŠŸèƒ½åˆ†åˆ«æ‰“å¼€</li>
                        <li><strong>å…¨å±æŒ‰é’®ï¼š</strong>ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®è¿›å…¥å…¨å±æµè§ˆ</li>
                        <li><strong>ç‚¹å‡»æ™¯åŒºï¼š</strong>ç‚¹å‡»ä½ æ„Ÿå…´è¶£çš„æ™¯åŒºä¼šè‡ªåŠ¨è½¬è·³å°çº¢ä¹¦</li>
                    </ol>
                `;
            } else {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>æ‰“å¼€åˆ†å±ï¼š</strong>ç‚¹å‡»Edgeå³ä¸Šè§’ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©"æ‰“å¼€åˆ†å±"</li>
                        <li><strong>æ‰“å¼€å°çº¢ä¹¦ï¼š</strong>åœ¨å³ä¾§æœç´¢å¹¶æ‰“å¼€å°çº¢ä¹¦ç½‘é¡µç‰ˆï¼Œç™»å½•è´¦å·</li>
                        <li><strong>å¯ç”¨è”åŠ¨ï¼š</strong>ç‚¹å‡»åœ°å€æ ä¸­é—´çš„"æ‰“å¼€å³ä¾§çš„å·¦ä¾§é“¾æ¥"æŒ‰é’®</li>
                        <li><strong>ç‚¹å‡»æ™¯ç‚¹ï¼š</strong>ç‚¹å‡»å·¦ä¾§åœ°å›¾ä¸Šçš„æ™¯ç‚¹ï¼Œå³ä¾§å°çº¢ä¹¦ä¼šè‡ªåŠ¨è·³è½¬æœç´¢</li>
                    </ol>
                `;
            }
            
            guide.classList.add('show');
        }
        
        function closeWelcome() {
            const guide = document.getElementById('welcomeGuide');
            guide.classList.remove('show');
            localStorage.setItem('welcomeShown', 'true');
        }
        
        function toggleWelcome() {
            const guide = document.getElementById('welcomeGuide');
            const steps = document.getElementById('welcomeSteps');
            
            // æ›´æ–°å†…å®¹ï¼ˆæ¯æ¬¡æ‰“å¼€éƒ½åˆ·æ–°ï¼Œä»¥é˜²è®¾å¤‡ç±»å‹æ£€æµ‹æœ‰å˜åŒ–ï¼‰
            if (IS_MOBILE) {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>æ‰“å¼€åˆ†å±ï¼š</strong>å°†æ­¤ç½‘é¡µä¸å°çº¢ä¹¦appé€šè¿‡æ‰‹æœºåˆ†å±åŠŸèƒ½åˆ†åˆ«æ‰“å¼€</li>
                        <li><strong>å…¨å±æŒ‰é’®ï¼š</strong>ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®è¿›å…¥å…¨å±æµè§ˆ</li>
                        <li><strong>ç‚¹å‡»æ™¯åŒºï¼š</strong>ç‚¹å‡»ä½ æ„Ÿå…´è¶£çš„æ™¯åŒºä¼šè‡ªåŠ¨è½¬è·³å°çº¢ä¹¦</li>
                    </ol>
                `;
            } else {
                steps.innerHTML = `
                    <ol class="welcome-steps">
                        <li><strong>æ‰“å¼€åˆ†å±ï¼š</strong>ç‚¹å‡»Edgeå³ä¸Šè§’ä¸‰ä¸ªç‚¹ï¼Œé€‰æ‹©"æ‰“å¼€åˆ†å±"</li>
                        <li><strong>æ‰“å¼€å°çº¢ä¹¦ï¼š</strong>åœ¨å³ä¾§æœç´¢å¹¶æ‰“å¼€å°çº¢ä¹¦ç½‘é¡µç‰ˆï¼Œç™»å½•è´¦å·</li>
                        <li><strong>å¯ç”¨è”åŠ¨ï¼š</strong>ç‚¹å‡»åœ°å€æ ä¸­é—´çš„"æ‰“å¼€å³ä¾§çš„å·¦ä¾§é“¾æ¥"æŒ‰é’®</li>
                        <li><strong>ç‚¹å‡»æ™¯ç‚¹ï¼š</strong>ç‚¹å‡»å·¦ä¾§åœ°å›¾ä¸Šçš„æ™¯ç‚¹ï¼Œå³ä¾§å°çº¢ä¹¦ä¼šè‡ªåŠ¨è·³è½¬æœç´¢</li>
                    </ol>
                `;
            }
            
            if (guide.classList.contains('show')) {
                guide.classList.remove('show');
            } else {
                guide.classList.add('show');
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡è®¿é—®
        function checkFirstVisit() {
            const hasShown = localStorage.getItem('welcomeShown');
            if (!hasShown) {
                setTimeout(showWelcome, 500);
            }
        }
        

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            // ç§»åŠ¨ç«¯ç¼©çŸ­ä¸‹æ‹‰æ¡†æ–‡å­—
            if (IS_MOBILE) {
                const levelSelect = document.getElementById('levelSelect');
                const options = levelSelect.options;
                for (let i = 1; i < options.length; i++) {
                    const value = options[i].value;
                    options[i].text = value + '+';
                }
            }
            
            åˆå§‹åŒ–åœ°å›¾();
            åŠ è½½æ™¯åŒºæ•°æ®();
            // äº¤äº’äº‹ä»¶ï¼šè§†å£æˆ–ç­‰çº§å˜åŒ–æ—¶é‡è½½
            map.addEventListener('zoomstart', function(){
                isDragging = true;
                ç§»é™¤æ‰€æœ‰æç¤º();
            });
            map.addEventListener('zoomend', function(){
                isDragging = false;
                é˜²æŠ–åŠ è½½();
            });
            map.addEventListener('dragstart', function() {
                isDragging = true;
                ç§»é™¤æ‰€æœ‰æç¤º();
            });
            map.addEventListener('dragend', function() {
                isDragging = false;
                lastDragTime = Date.now();
                é˜²æŠ–åŠ è½½();
            });
            document.getElementById('levelSelect').addEventListener('change', ç­‰çº§åˆ‡æ¢åˆ·æ–°);

            // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–
            window.addEventListener('resize', ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–);

            // åº•å›¾æ§åˆ¶
            const basemapSelect = document.getElementById('basemapSelect');
            basemapSelect.addEventListener('change', () => åˆ‡æ¢åº•å›¾(basemapSelect.value));
            
            // å…¨å±æŒ‰é’®åŠŸèƒ½
            if (IS_MOBILE) {
                const fullscreenBtn = document.getElementById('fullscreenBtn');
                fullscreenBtn.addEventListener('click', function() {
                    const elem = document.documentElement;
                    
                    if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                        !document.mozFullScreenElement && !document.msFullscreenElement) {
                        // è¿›å…¥å…¨å±
                        if (elem.requestFullscreen) {
                            elem.requestFullscreen();
                        } else if (elem.webkitRequestFullscreen) {
                            elem.webkitRequestFullscreen();
                        } else if (elem.mozRequestFullScreen) {
                            elem.mozRequestFullScreen();
                        } else if (elem.msRequestFullscreen) {
                            elem.msRequestFullscreen();
                        }
                        fullscreenBtn.textContent = 'â›¶';
                    } else {
                        // é€€å‡ºå…¨å±
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        } else if (document.mozCancelFullScreen) {
                            document.mozCancelFullScreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        }
                        fullscreenBtn.textContent = 'â›¶';
                    }
                });
                
                // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
                document.addEventListener('fullscreenchange', updateFullscreenButton);
                document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
                document.addEventListener('mozfullscreenchange', updateFullscreenButton);
                document.addEventListener('MSFullscreenChange', updateFullscreenButton);
                
                function updateFullscreenButton() {
                    const fullscreenBtn = document.getElementById('fullscreenBtn');
                    if (document.fullscreenElement || document.webkitFullscreenElement || 
                        document.mozFullScreenElement || document.msFullscreenElement) {
                        fullscreenBtn.textContent = 'â›¶';
                    } else {
                        fullscreenBtn.textContent = 'â›¶';
                    }
                }
            }
            
            // æ£€æŸ¥é¦–æ¬¡è®¿é—®
            checkFirstVisit();
            
            // å¸®åŠ©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', toggleWelcome);
            }
        };
    </script>
</body>
</html>
